function CmdStack(id,max_size){"use strict";var instance_id=id,cur=0,arr=[];if(typeof id!=="string"){throw"Stack error: id should be a string."}if(typeof max_size!=="number"){throw"Stack error: max_size should be a number."}function setArray(arr){localStorage["cmd_stack_"+instance_id]=JSON.stringify(arr)}function getArray(){if(!localStorage["cmd_stack_"+instance_id]){arr=[];setArray(arr)}try{arr=JSON.parse(localStorage["cmd_stack_"+instance_id])}catch(err){return[]}return arr}function push(cmd){arr=getArray();if(cmd===arr[arr.length-1]){return false}arr.push(cmd);while(arr.length>max_size){arr.shift()}cur=arr.length;setArray(arr)}function prev(){cur-=1;if(cur<0){cur=0}return arr[cur]}function next(){cur=cur+1;if(cur===arr.length){return""}if(cur>arr.length-1){cur=arr.length-1}return arr[cur]}function reset(){arr=getArray();cur=arr.length}function isEmpty(){arr=getArray();return arr.length===0}function empty(){arr=undefined;localStorage.clear();reset()}function getCur(){return cur}function getArr(){return arr}function getSize(){return arr.size}return{push:push,prev:prev,next:next,reset:reset,isEmpty:isEmpty,empty:empty,getCur:getCur,getArr:getArr,getSize:getSize}}var Cmd=function($){return function(user_config){"use strict";var keys_array=[9,13,38,40,27],style="dark",popup=false,prompt_str="$ ",options={selector:"#cmd",response_handler:function(){},unknown_cmd:"Unrecognised command",invalid_response:"Invalid response.",style:"dark",light_css:"assets/css/chimpcom_light.min.css",dark_css:"assets/css/chimpcom_dark.min.css",file_upload_url:"ajax/uploadfile.php",filedrop_enabled:false,timeout_length:1e4,history_id:"cmd_history"},cmd_stack,container,dropzone,input,output,prompt_elem,wrapper;$.extend(options,user_config);if(!$(options.selector).length){throw"Cmd err: Invalid selector."}setupDOM();cmd_stack=new CmdStack(options.history_id,30);if(cmd_stack.isEmpty()){cmd_stack.push("secretmagicword!")}cmd_stack.reset();input.focus();function setupDOM(){wrapper=$(options.selector);container=$("<div/>").addClass("cmd-container").appendTo(wrapper);if(options.filedrop_enabled){setupFiledrop()}clearScreen();$(options.selector).on("click",focusOnInput);$(window).resize(resizeInput);wrapper.keydown(handleKeyDown);wrapper.keyup(handleKeyUp);wrapper.keydown(handleKeyPress)}function showInputType(input_type){switch(input_type){case"password":input=$("<input/>").attr("type","password").attr("maxlength",512).addClass("cmd-in");break;case"textarea":input=$("<textarea/>").addClass("cmd-in");break;default:input=$("<input/>").attr("type","text").attr("maxlength",512).addClass("cmd-in")}container.children(".cmd-in").remove();input.appendTo(container);focusOnInput()}function displayOutput(cmd_in,cmd_out){cmd_in=cmd_in.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");output.append($("<span/>").addClass("prompt").html(prompt_str));output.append(" ");output.append($("<span/>").addClass("grey_text").html(cmd_in));output.append("<br>"+cmd_out+"<br>");cmd_stack.reset();input.val("").removeAttr("disabled");focusOnInput()}function appendOutput(msg){output.append(msg)}function setPrompt(new_prompt){if(typeof new_prompt!=="string"){throw"Cmd error: invalid prompt string."}prompt_str=new_prompt}function resetDropzone(){dropzone.css("display","none")}function setupFiledrop(){dropzone=$("<div/>").addClass("dropzone").appendTo(wrapper).filedrop({url:options.file_upload_url,paramname:"dropfile",maxfiles:10,maxfilesize:2,error:function(err,file){switch(err){case"BrowserNotSupported":alert("Your browser does not support html5 drag and drop.");break;case"TooManyFiles":displayOutput("[File Upload]","Too many files!");resetDropzone();break;case"FileTooLarge":displayOutput("[File Upload]","File too big!");resetDropzone();break;default:displayOutput("[File Upload]","Fail D:");resetDropzone();break}},dragOver:function(){dropzone.css("display","block")},dragLeave:function(){resetDropzone()},docOver:function(){dropzone.css("display","block")},docLeave:function(){resetDropzone()},drop:function(){dropzone.append("<br>File dropped.")},uploadStarted:function(i,file,len){dropzone.append("<br>Upload started...")},uploadFinished:function(i,file,response,time){if(response.error!==""){upload_error=response.error}dropzone.append("<br>Upload finished! "+response.result)},progressUpdated:function(i,file,progress){dropzone.append("<br>File uploading...")},speedUpdated:function(i,file,speed){dropzone.append("<br>Upload speed: "+speed)},afterAll:function(){if(upload_error!==""){displayOutput("[File Upload]","Error: "+upload_error)}else{displayOutput("[File Upload]","Success!")}upload_error="";dropzone.css("display","none");resetDropzone()}})}function invert(){var style=$("#cmd-style");if(options.style==="dark"){options.style="light";style.attr("href",options.light_css)}else{options.style="dark";style.attr("href",options.dark_css)}}function handleInput(input_str){if(!input_str){return false}var cmd_array=input_str.split(" ");switch(cmd_array[0]){case"clear":case"cls":case"clr":clearScreen();break;case"timeout":var new_timeout=parseInt(cmd_array[1],10);if(!new_timeout){displayOutput(input_str,"Timeout is currently "+options.timeout_length);return false}if(typeof new_timeout!=="number"||isNaN(new_timeout)){displayOutput(input_str,"That was not a number.");return false}if(new_timeout<1e3){new_timeout=1e3}options.timeout_length=new_timeout;displayOutput(input_str,"Timeout set to "+options.timeout_length+"ms.");break;case"clearhistory":displayOutput(input_str,"Command history cleared. ");cmd_stack.empty();cmd_stack.reset();break;case"invert":invert();displayOutput(input_str,"Shazam.");break;default:if(typeof options.callback!=="function"){displayOutput(input_str,options.unknown_cmd);return false}var result=options.callback(input_str);switch(typeof result){case"undefined":console.log("No return value. Expecting callback instead.");break;case"object":console.log("Response object received.");displayOutput(input_str,result.response);break;default:console.log("default....");console.log(result);displayOutput(input_str,options.invalid_response)}}}function handleResponse(res){if(res.redirect!==undefined){document.location.href=res.redirect}if(res.openWindow!==undefined){window.open(res.openWindow,"_blank",res.openWindowSpecs)}if(res.log!==undefined&&res.log!==""){console.log(res.log)}if(res.hide_output===true){res.cmd_in=new Array(cmd_in.length).join("*")}if(res.show_pass===true){showInputType("password")}else{showInputType()}displayOutput(res.cmd_in,res.cmd_out);if(res.cmd_fill!==""){wrapper.children(".cmd-container").children(".cmd-in").first().val(res.cmd_fill)}activateAutofills()}function handleKeyPress(e){var keyCode=e.keyCode||e.which,input_str=input.val();if(keyCode===13){if(e.ctrlKey){cmd_stack.push(input_str);goToURL(input_str)}else{if(input.get(0).type==="text"){cmd_stack.push(input_str)}handleInput(input_str)}}else if(keyCode===38){if(input_str!==""&&cmd_stack.cur===cmd_stack.getSize()-1){cmd_stack.push(input_str)}input.val(cmd_stack.prev())}else if(keyCode===40){input.val(cmd_stack.next())}else if(keyCode===27){container.fadeToggle()}}function handleKeyUp(e){var key=e.which;if($.inArray(key,keys_array)>-1){e.preventDefault();return false}return true}function handleKeyDown(e){var key=e.which;if($.inArray(key,keys_array)>-1){e.preventDefault();return false}return true}function goToURL(url){if(url.substr(0,4)!=="http"&&url.substr(0,2)!=="//"){url="http://"+url}if(popup){window.open(url,"_blank");window.focus()}else{if(top.location!==location){top.location.href=document.location.href}location.href=url}}function focusOnInput(){var cmd_width;$(options.selector).scrollTop($(options.selector)[0].scrollHeight);input.focus()}function resizeInput(){cmd_width=window.innerWidth-wrapper.find(".main-prompt").first().width()-45;input.focus().css("width",cmd_width)}function clearScreen(){container.empty();output=$("<div/>").addClass("cmd-output").appendTo(container);prompt_elem=$("<span/>").addClass("main-prompt").addClass("prompt").html(prompt_str).appendTo(container);input=$("<input/>").addClass("cmd-in").attr("type","text").attr("maxlength",512).appendTo(container);showInputType();input.val("")}return{appendOutput:appendOutput,clearScreen:clearScreen,handleResponse:handleResponse,invert:invert,options:options,setPrompt:setPrompt,showInputType:showInputType}}}(jQuery);