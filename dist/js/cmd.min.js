function CmdStack(id,max_size){"use strict";var instance_id=id,cur=0,arr=[];if(typeof id!=="string"){throw"Stack error: id should be a string."}if(typeof max_size!=="number"){throw"Stack error: max_size should be a number."}function setArray(arr){localStorage["cmd_stack_"+instance_id]=JSON.stringify(arr)}function getArray(){if(!localStorage["cmd_stack_"+instance_id]){arr=[];setArray(arr)}try{arr=JSON.parse(localStorage["cmd_stack_"+instance_id])}catch(err){return[]}return arr}function push(cmd){arr=getArray();if(cmd===arr[arr.length-1]){return false}arr.push(cmd);while(arr.length>max_size){arr.shift()}cur=arr.length;setArray(arr)}function prev(){cur-=1;if(cur<0){cur=0}return arr[cur]}function next(){cur=cur+1;if(cur===arr.length){return""}if(cur>arr.length-1){cur=arr.length-1}return arr[cur]}function reset(){arr=getArray();cur=arr.length}function isEmpty(){arr=getArray();return arr.length===0}function empty(){arr=undefined;localStorage.clear();reset()}function getCur(){return cur}function getArr(){return arr}function getSize(){return arr.size}return{push:push,prev:prev,next:next,reset:reset,isEmpty:isEmpty,empty:empty,getCur:getCur,getArr:getArr,getSize:getSize}}var Cmd=function($){return function(user_config){"use strict";var keys_array=[9,13,38,40,27],style="dark",popup=false,prompt_str="$ ",speech_synth_support="speechSynthesis"in window&&typeof SpeechSynthesisUtterance!=="undefined",options={busy_text:"Communicating...",external_processor:function(){},file_upload_url:"ajax/uploadfile.php",filedrop_enabled:false,history_id:"cmd_history",selector:"#cmd",talk:false,timeout_length:1e4,unknown_cmd:"Unrecognised command"},cmd_stack,container,dropzone,input,output,prompt_elem,voice,voices=false,wrapper;$.extend(options,user_config);if(!$(options.selector).length){throw"Cmd err: Invalid selector."}cmd_stack=new CmdStack(options.history_id,30);if(cmd_stack.isEmpty()){cmd_stack.push("secretmagicword!")}cmd_stack.reset();setupDOM();input.focus();function setupDOM(){wrapper=$(options.selector).addClass("cmd-interface");container=$("<div/>").addClass("cmd-container").appendTo(wrapper);if(options.filedrop_enabled){setupFiledrop()}clearScreen();$(options.selector).on("click",focusOnInput);$(window).resize(resizeInput);wrapper.keydown(handleKeyDown);wrapper.keyup(handleKeyUp);wrapper.keydown(handleKeyPress)}function showInputType(input_type){switch(input_type){case"password":input=$("<input/>").attr("type","password").attr("maxlength",512).addClass("cmd-in");break;case"textarea":input=$("<textarea/>").addClass("cmd-in");break;default:input=$("<input/>").attr("type","text").attr("maxlength",512).addClass("cmd-in")}container.children(".cmd-in").remove();input.appendTo(container).attr("title","Chimpcom input");focusOnInput()}function displayOutput(cmd_in,cmd_out){if(typeof cmd_in!=="string"){cmd_in="Error: invalid cmd_in returned."}if(typeof cmd_out!=="string"){cmd_out="Error: invalid cmd_out returned."}cmd_in=cmd_in.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");output.append($("<span/>").addClass("prompt").html(prompt_str));output.append(" ");output.append($("<span/>").addClass("grey_text").html(cmd_in));output.append("<br>"+cmd_out+"<br>");if(options.talk){speakOutput(cmd_out)}cmd_stack.reset();input.val("").removeAttr("disabled");enableInput();focusOnInput()}function appendOutput(msg){output.append(msg)}function setPrompt(new_prompt){if(typeof new_prompt!=="string"){throw"Cmd error: invalid prompt string."}prompt_str=new_prompt;prompt_elem.html(prompt_str)}function resetDropzone(){dropzone.css("display","none")}function setupFiledrop(){dropzone=$("<div/>").addClass("dropzone").appendTo(wrapper).filedrop({url:options.file_upload_url,paramname:"dropfile",maxfiles:10,maxfilesize:2,error:function(err,file){switch(err){case"BrowserNotSupported":alert("Your browser does not support html5 drag and drop.");break;case"TooManyFiles":displayOutput("[File Upload]","Too many files!");resetDropzone();break;case"FileTooLarge":displayOutput("[File Upload]","File too big!");resetDropzone();break;default:displayOutput("[File Upload]","Fail D:");resetDropzone();break}},dragOver:function(){dropzone.css("display","block")},dragLeave:function(){resetDropzone()},docOver:function(){dropzone.css("display","block")},docLeave:function(){resetDropzone()},drop:function(){dropzone.append("<br>File dropped.")},uploadStarted:function(i,file,len){dropzone.append("<br>Upload started...")},uploadFinished:function(i,file,response,time){if(response.error!==""){upload_error=response.error}dropzone.append("<br>Upload finished! "+response.result)},progressUpdated:function(i,file,progress){dropzone.append("<br>File uploading...")},speedUpdated:function(i,file,speed){dropzone.append("<br>Upload speed: "+speed)},afterAll:function(){if(upload_error!==""){displayOutput("[File Upload]","Error: "+upload_error)}else{displayOutput("[File Upload]","Success!")}upload_error="";dropzone.css("display","none");resetDropzone()}})}function invert(){wrapper.toggleClass("inverted")}function handleInput(input_str){var cmd_array=input_str.split(" ");switch(cmd_array[0]){case"":displayOutput("","");break;case"clear":case"cls":case"clr":clearScreen();break;case"clearhistory":cmd_stack.empty();cmd_stack.reset();displayOutput(input_str,"Command history cleared. ");break;case"invert":invert();displayOutput(input_str,"Shazam.");break;case"shh":if(options.talk){window.speechSynthesis.cancel();options.talk=false;displayOutput(input_str,"Speech stopped. Talk mode is still enabled. Type TALK to disable talk mode.");options.talk=true}else{displayOutput(input_str,"Ok.")}break;case"talk":if(!speech_synth_support){displayOutput(input_str,"You browser doesn't support speech synthesis.");return false}options.talk=!options.talk;displayOutput(input_str,options.talk?"Talk mode enabled.":"Talk mode disabled.");break;default:if(typeof options.external_processor!=="function"){displayOutput(input_str,options.unknown_cmd);return false}var result=options.external_processor(input_str,cmd);switch(typeof result){case"boolean":if(!result){displayOutput(input_str,options.unknown_cmd)}break;case"object":handleResponse(result);break;case"string":displayOutput(input_str,result);break;default:displayOutput(input_str,options.unknown_cmd)}}}function handleResponse(res){if(res.redirect!==undefined){document.location.href=res.redirect}if(res.openWindow!==undefined){window.open(res.openWindow,"_blank",res.openWindowSpecs)}if(res.log!==undefined&&res.log!==""){console.log(res.log)}if(res.hide_output===true){res.cmd_in=new Array(cmd_in.length).join("*")}if(res.show_pass===true){showInputType("password")}else{showInputType()}displayOutput(res.cmd_in,res.cmd_out);if(res.cmd_fill!==""){wrapper.children(".cmd-container").children(".cmd-in").first().val(res.cmd_fill)}activateAutofills()}function handleKeyPress(e){var keyCode=e.keyCode||e.which,input_str=input.val();if(keyCode===13){if(input.attr("disabled")){return false}if(e.ctrlKey){cmd_stack.push(input_str);goToURL(input_str)}else{disableInput();if(input.get(0).type==="text"){cmd_stack.push(input_str)}handleInput(input_str)}}else if(keyCode===38){if(input_str!==""&&cmd_stack.cur===cmd_stack.getSize()-1){cmd_stack.push(input_str)}input.val(cmd_stack.prev())}else if(keyCode===40){input.val(cmd_stack.next())}else if(keyCode===27){if(container.css("opacity")>.5){container.animate({opacity:0},300)}else{container.animate({opacity:1},300)}}}function handleKeyUp(e){var key=e.which;if($.inArray(key,keys_array)>-1){e.preventDefault();return false}return true}function handleKeyDown(e){var key=e.which;if($.inArray(key,keys_array)>-1){e.preventDefault();return false}return true}function goToURL(url){if(url.substr(0,4)!=="http"&&url.substr(0,2)!=="//"){url="http://"+url}if(popup){window.open(url,"_blank");window.focus()}else{if(top.location!==location){top.location.href=document.location.href}location.href=url}}function focusOnInput(){var cmd_width;$(options.selector).scrollTop($(options.selector)[0].scrollHeight);input.focus()}function resizeInput(){var cmd_width=wrapper.width()-wrapper.find(".main-prompt").first().width()-45;input.focus().css("width",cmd_width)}function clearScreen(){container.empty();output=$("<div/>").addClass("cmd-output").appendTo(container);prompt_elem=$("<span/>").addClass("main-prompt").addClass("prompt").html(prompt_str).appendTo(container);input=$("<input/>").addClass("cmd-in").attr("type","text").attr("maxlength",512).appendTo(container);showInputType();input.val("")}function activateAutofills(){wrapper.find("[data-type=autofill]").on("click",function(){input.val($(this).data("autofill"))})}function disableInput(){input.attr("disabled",true).val(options.busy_text)}function enableInput(){input.removeAttr("disabled").val("")}function speakOutput(output){var msg=new SpeechSynthesisUtterance;msg.volume=1;msg.rate=1;msg.pitch=2;msg.lang="en-UK";msg.text=output;window.speechSynthesis.speak(msg)}var cmd={appendOutput:appendOutput,clearScreen:clearScreen,handleResponse:handleResponse,invert:invert,options:options,setPrompt:setPrompt,showInputType:showInputType,handleInput:handleInput};return cmd}}(jQuery);